name: Strategy 1 - Binary Injection

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-push:
    # Executes on the local on-premise server (Self-hosted Runner)
    runs-on: self-hosted
    defaults:
      run:
        # Base directory for the Rust workspace
        working-directory: ./honeybeepf

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust & bpf-linker
        # Ensures the host machine has the required toolchains and eBPF linker
        run: |
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          rustup toolchain install nightly
          rustup default nightly
          rustup component add rust-src
          # Check and install bpf-linker if not present in the host
          if ! command -v bpf-linker &> /dev/null; then
            cargo install bpf-linker
          fi

      - name: Build eBPF & Userspace
        # Leverages host CPU/RAM for high-performance compilation
        run: |
          # Enables nightly features required for eBPF compilation
          export RUSTC_BOOTSTRAP=1
          
          # 1. Build eBPF target (Requires -Z build-std=core for bpfel target)
          cargo build --release --package honeybeepf-ebpf --target=bpfel-unknown-none -Z build-std=core
          
          # 2. Build Userspace binary
          cargo build --release --package honeybeepf
          
          # 3. Stage the binary for Docker build context
          mkdir -p ../dist
          cp ../target/release/honeybeepf ../dist/

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        # Injects the pre-built binary into a lightweight runtime image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.simple
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/honeybeepf:strat1