apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "honeybeepf.fullname" . }}
  labels:
    {{- include "honeybeepf.labels" . | nindent 4 }}
data:
  RUST_LOG: {{ .Values.rustLog | quote }}
  {{- if .Values.output.otlp.endpoint }}
  {{- $otlpEndpoint := .Values.output.otlp.endpoint -}}
  {{- if or (hasPrefix "http://" $otlpEndpoint) (hasPrefix "https://" $otlpEndpoint) }}
  OTEL_EXPORTER_OTLP_ENDPOINT: {{ $otlpEndpoint | quote }}
  {{- else }}
  OTEL_EXPORTER_OTLP_ENDPOINT: {{ printf "http://%s" $otlpEndpoint | quote }}
  {{- end }}
  OTEL_SERVICE_NAME: "honeybeepf"
  {{- end }}
  BUILTIN_PROBES__BLOCK_IO: {{ .Values.builtinProbes.block_io.enabled | quote }}
  BUILTIN_PROBES__NETWORK_LATENCY: {{ .Values.builtinProbes.network_latency.enabled | quote }}
  # GPU Probes (hierarchical: gpu.usage, gpu.nccl)
  BUILTIN_PROBES__GPU__USAGE: {{ .Values.builtinProbes.gpu.usage.enabled | quote }}
  BUILTIN_PROBES__GPU__NCCL: {{ .Values.builtinProbes.gpu.nccl.enabled | quote }}
  {{- if .Values.builtinProbes.gpu.nccl.libPath }}
  HONEYBEEPF_NCCL_PATH: {{ .Values.builtinProbes.gpu.nccl.libPath | quote }}
  {{- end }}
  # LLM Probes
  BUILTIN_PROBES__LLM: {{ .Values.builtinProbes.llm.enabled | quote }}
  {{- if .Values.builtinProbes.llm.providers }}
  LLM_PROVIDERS_CONFIG: {{ dict "providers" .Values.builtinProbes.llm.providers | toJson | quote }}
  {{- end }}
  # Collection Interval
  BUILTIN_PROBES__INTERVAL: {{ .Values.builtinProbes.interval | quote }}
  {{- if or .Values.customProbes.kprobes .Values.customProbes.uprobes .Values.customProbes.tracepoints }}
  CUSTOM_PROBE_CONFIG: {{ toJson .Values.customProbes | quote }}
  {{- end }}