apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "honeybeepf.fullname" . }}
  labels:
    {{- include "honeybeepf.labels" . | nindent 4 }}
data:
  RUST_LOG: {{ .Values.rustLog | quote }}
  
  {{- if .Values.output.otlp.endpoint }}
  {{- $otlpEndpoint := .Values.output.otlp.endpoint -}}
  {{- if or (hasPrefix "http://" $otlpEndpoint) (hasPrefix "https://" $otlpEndpoint) }}
  OTEL_EXPORTER_OTLP_ENDPOINT: {{ $otlpEndpoint | quote }}
  {{- else }}
  OTEL_EXPORTER_OTLP_ENDPOINT: {{ printf "http://%s" $otlpEndpoint | quote }}
  {{- end }}
  OTEL_SERVICE_NAME: "honeybeepf"
  {{- end }}

  # === Network Probes ===
  BUILTIN_PROBES__NETWORK__TCP_CONNECT: {{ .Values.builtinProbes.network.tcp_connect.enabled | quote }}
  BUILTIN_PROBES__NETWORK__TCP_RETRANS: {{ .Values.builtinProbes.network.tcp_retrans.enabled | quote }}
  BUILTIN_PROBES__NETWORK__DNS: {{ .Values.builtinProbes.network.dns.enabled | quote }}

  # === Filesystem Probes ===
  BUILTIN_PROBES__FILESYSTEM__VFS_LATENCY: {{ .Values.builtinProbes.filesystem.vfs_latency.enabled | quote }}
  {{- if .Values.builtinProbes.filesystem.vfs_latency.threshold_ms }}
  BUILTIN_PROBES__FILESYSTEM__VFS_LATENCY_THRESHOLD_MS: {{ .Values.builtinProbes.filesystem.vfs_latency.threshold_ms | quote }}
  {{- end }}
  BUILTIN_PROBES__FILESYSTEM__FILE_ACCESS: {{ .Values.builtinProbes.filesystem.file_access.enabled | quote }}
  {{- if .Values.builtinProbes.filesystem.file_access.watched_paths }}
  {{- /* config-rs parses comma-separated values into Vec<String> */ -}}
  BUILTIN_PROBES__FILESYSTEM__WATCHED_PATHS: {{ .Values.builtinProbes.filesystem.file_access.watched_paths | join "," | quote }}
  {{- end }}

  # === Scheduler Probes ===
  BUILTIN_PROBES__SCHEDULER__RUNQUEUE: {{ .Values.builtinProbes.scheduler.runqueue.enabled | quote }}
  {{- if .Values.builtinProbes.scheduler.runqueue.threshold_ms }}
  BUILTIN_PROBES__SCHEDULER__RUNQUEUE_THRESHOLD_MS: {{ .Values.builtinProbes.scheduler.runqueue.threshold_ms | quote }}
  {{- end }}
  BUILTIN_PROBES__SCHEDULER__OFFCPU: {{ .Values.builtinProbes.scheduler.offcpu.enabled | quote }}
  {{- if .Values.builtinProbes.scheduler.offcpu.threshold_ms }}
  BUILTIN_PROBES__SCHEDULER__OFFCPU_THRESHOLD_MS: {{ .Values.builtinProbes.scheduler.offcpu.threshold_ms | quote }}
  {{- end }}

  # === LLM Probes ===
  BUILTIN_PROBES__LLM: {{ .Values.builtinProbes.llm.enabled | quote }}
  {{- if .Values.builtinProbes.llm.providers }}
  LLM_PROVIDERS_CONFIG: {{ dict "providers" .Values.builtinProbes.llm.providers | toJson | quote }}
  {{- end }}

  # === Collection Interval ===
  BUILTIN_PROBES__INTERVAL: {{ .Values.builtinProbes.interval | quote }}

  # === Custom Probes ===
  {{- if or .Values.customProbes.kprobes .Values.customProbes.uprobes .Values.customProbes.tracepoints }}
  CUSTOM_PROBE_CONFIG: {{ toJson .Values.customProbes | quote }}
  {{- end }}